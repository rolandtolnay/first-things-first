---
phase: 05.1-cross-section-drag-drop
plan: 02
type: execute
wave: 2
depends_on: ["05.1-01"]
files_modified:
  - src/components/dnd/DndProvider.tsx
autonomous: true

must_haves:
  truths:
    - "Dragging time block to priorities creates priority item"
    - "Dragging time block to evening creates evening block"
    - "Dragging evening block to priorities creates priority item"
    - "Dragging evening block to time slot creates time block"
    - "Dragging evening block to different day's evening moves it"
    - "Dragging priority item to time slot creates time block"
    - "Dragging priority item to evening creates evening block"
    - "Dragging priority item to different day's priorities moves it"
  artifacts:
    - path: "src/components/dnd/DndProvider.tsx"
      provides: "Cross-section drop handling"
      contains: "handlePriorityDrop"
  key_links:
    - from: "DndProvider.tsx"
      to: "weekStore"
      via: "addDayPriority, addTimeBlock, addEveningBlock, deleteTimeBlock, etc."
      pattern: "addDayPriority|addTimeBlock|addEveningBlock"
---

<objective>
Handle all cross-section drop combinations in DndProvider.

Purpose: Complete the drag-drop matrix so items can move between any section.
Output: Full bidirectional drag-drop between sidebar, priorities, timegrid, and evening sections.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-cross-section-drag-drop/05.1-01-SUMMARY.md

@src/components/dnd/DndProvider.tsx
@src/stores/weekStore.ts
@src/types/dnd.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Handle TimeBlock drops to priorities and evening</name>
  <files>src/components/dnd/DndProvider.tsx</files>
  <action>
Extend handleDragEnd to handle TimeBlock (type === "block") drops to new zones:

1. **Block → Priorities**:
   - Get block data from store using blockId
   - If block has goalId: create DayPriority with goalId
   - Delete the original time block
   - NOTE: If block is freestyle (no goalId), silently skip (priorities need goals)

2. **Block → Evening**:
   - Check if target day already has evening block (silently skip if occupied)
   - Get block data from store using blockId
   - Create EveningBlock with:
     - type: block.type ("goal" or "freestyle")
     - goalId: block.goalId (if present)
     - roleId: block.roleId (if present)
     - dayIndex: dropData.dayIndex
     - title: block.title
     - completed: false
   - Delete the original time block

Current code only handles block → timegrid. Add new conditions BEFORE that check to handle priorities and evening zones.
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>TimeBlocks can be dropped on priorities and evening sections</done>
</task>

<task type="auto">
  <name>Task 2: Handle PriorityItem drops</name>
  <files>src/components/dnd/DndProvider.tsx</files>
  <action>
Add handler for PriorityDragData (type === "priority") drops:

1. **Priority → Timegrid**:
   - Create TimeBlock with:
     - type: "goal"
     - goalId: dragData.goalId
     - roleId: dragData.roleId
     - dayIndex: dropData.dayIndex
     - startSlot: dropData.slotIndex
     - duration: 2 (1 hour default)
     - title: dragData.text
     - completed: false
   - Delete the original priority using removeDayPriority(dragData.priorityId)

2. **Priority → Evening**:
   - Check if target day already has evening block (silently skip if occupied)
   - Create EveningBlock with:
     - type: "goal"
     - goalId: dragData.goalId
     - roleId: dragData.roleId
     - dayIndex: dropData.dayIndex
     - title: dragData.text
     - completed: false
   - Delete the original priority

3. **Priority → Priorities (different day)**:
   - Check if same day (dragData.sourceDayIndex === dropData.dayIndex) → skip (no-op)
   - Create new DayPriority with goalId on the new day
   - Delete the original priority
   - This is a MOVE, not a copy

Add new store action import: removeDayPriority
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>Priority items can be dropped on timegrid, evening, and other day's priorities</done>
</task>

<task type="auto">
  <name>Task 3: Handle EveningBlock drops</name>
  <files>src/components/dnd/DndProvider.tsx</files>
  <action>
Add handler for EveningDragData (type === "evening") drops:

1. **Evening → Priorities**:
   - Evening blocks may or may not have a goalId
   - If no goalId (freestyle): silently skip (priorities need goals)
   - If has goalId: create DayPriority with goalId
   - Delete the original evening block

2. **Evening → Timegrid**:
   - Create TimeBlock with:
     - type: eveningBlock has goalId ? "goal" : "freestyle"
     - goalId: dragData.goalId (if present)
     - roleId: dragData.roleId (if present)
     - dayIndex: dropData.dayIndex
     - startSlot: dropData.slotIndex
     - duration: 2 (1 hour default)
     - title: dragData.title
     - completed: false
   - Delete the original evening block

3. **Evening → Evening (different day)**:
   - Check if same day (dragData.sourceDayIndex === dropData.dayIndex) → skip (no-op)
   - Check if target day already has evening block → skip if occupied
   - Get the full evening block data from store
   - Create new EveningBlock on target day with same data (new id)
   - Delete the original evening block
   - This is a MOVE, not a copy

Add new store action import: deleteEveningBlock
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>Evening blocks can be dropped on priorities, timegrid, and other day's evening</done>
</task>

<task type="auto">
  <name>Task 4: Update dropAnimation for new draggable types</name>
  <files>src/components/dnd/DndProvider.tsx</files>
  <action>
Update the dropAnimation logic in DragOverlay:

Currently: `dropAnimation={activeData?.type === "block" ? { duration: 200, easing: "ease" } : null}`

Goals create copies (no animation needed - null).
Blocks, priorities, and evening blocks MOVE (they get deleted from source), so they need animation.

Update to:
```typescript
dropAnimation={
  activeData?.type === "goal"
    ? null  // Goals create copies, no swoosh-back needed
    : { duration: 200, easing: "ease" }  // Everything else moves
}
```

This ensures priority and evening drags have smooth animation on successful drop.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
  </verify>
  <done>Drop animation configured correctly for all draggable types</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] App loads without console errors
- [ ] Drag time block to priorities → creates priority, removes block
- [ ] Drag time block to evening → creates evening block, removes time block
- [ ] Drag priority to timegrid → creates time block, removes priority
- [ ] Drag priority to evening → creates evening block, removes priority
- [ ] Drag priority to different day's priorities → moves priority
- [ ] Drag evening block to priorities → creates priority (if goal-based), removes evening
- [ ] Drag evening block to timegrid → creates time block, removes evening
- [ ] Drag evening block to different day's evening → moves evening block
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- All cross-section drag-drop combinations work
- Items are MOVED (deleted from source, created at target) not copied
- Drop animation plays for moving items (not for goals which create copies)
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-cross-section-drag-drop/05.1-02-SUMMARY.md`
</output>
