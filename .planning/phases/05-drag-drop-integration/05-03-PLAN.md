---
phase: 05-drag-drop-integration
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/calendar/TimeSlot.tsx
  - src/components/calendar/TimeGrid.tsx
  - src/components/calendar/TimeBlock.tsx
  - src/components/calendar/EveningSlot.tsx
  - src/components/dnd/DndProvider.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag goal from sidebar to time slot"
    - "Dropping on time slot creates 1-hour TimeBlock"
    - "User can drag goal to evening slot"
    - "Dropping on evening creates EveningBlock"
    - "Blocks display with role color and title"
  artifacts:
    - path: "src/components/calendar/TimeSlot.tsx"
      provides: "Drop zone for time grid"
      contains: "useDroppable"
    - path: "src/components/calendar/TimeBlock.tsx"
      provides: "Visual rendering of scheduled blocks"
      min_lines: 40
    - path: "src/components/calendar/EveningSlot.tsx"
      provides: "Drop zone for evening"
      contains: "useDroppable"
  key_links:
    - from: "TimeSlot"
      to: "DndContext"
      via: "useDroppable hook"
      pattern: "useDroppable"
    - from: "DndProvider onDragEnd"
      to: "weekStore.addTimeBlock"
      via: "drop handler for timegrid zone"
      pattern: "addTimeBlock"
    - from: "DndProvider onDragEnd"
      to: "weekStore.addEveningBlock"
      via: "drop handler for evening zone"
      pattern: "addEveningBlock"
---

<objective>
Enable dropping goals from sidebar onto calendar time grid and evening slots to create scheduled blocks.

Purpose: Second drag-drop interaction - goals to calendar creates time blocks.
Output: Goals can be dropped onto time slots (1hr block) and evening slots.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-drag-drop-integration/05-RESEARCH.md
@.planning/phases/05-drag-drop-integration/05-01-SUMMARY.md

@src/components/calendar/TimeSlot.tsx
@src/components/calendar/TimeGrid.tsx
@src/components/calendar/EveningSlot.tsx
@src/components/dnd/DndProvider.tsx
@src/stores/weekStore.ts
@src/types/dnd.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TimeBlock component</name>
  <files>src/components/calendar/TimeBlock.tsx</files>
  <action>
    Create component to render a time block in the calendar:

    1. "use client" component
    2. Props: block: TimeBlock (from @/types)
    3. Import getRoleColorStyle from @/lib/role-colors
    4. Import useWeekStore for deleteTimeBlock
    5. Calculate height based on duration: block.duration * 32px (slot height is h-8 = 32px)
    6. Calculate top position: block.startSlot * 32px
    7. Display:
       - Absolute positioned within the TimeGrid
       - Background with role color (use getRoleColorStyle with opacity)
       - Left border with solid role color (3px)
       - Block title (truncated)
       - Delete button on hover
    8. Style:
       - position: absolute
       - top: calculated
       - left: 0, right: 0 (full width of slot)
       - height: calculated
       - z-index: 10 (above empty slots)
       - rounded-sm, overflow-hidden

    For blocks without roleId (freestyle), use a neutral color (bg-muted).
  </action>
  <verify>tsc --noEmit passes</verify>
  <done>TimeBlock component renders with correct height/position based on duration/startSlot</done>
</task>

<task type="auto">
  <name>Task 2: Make TimeSlot a drop zone and render blocks</name>
  <files>src/components/calendar/TimeSlot.tsx, src/components/calendar/TimeGrid.tsx</files>
  <action>
    **TimeSlot.tsx:**
    1. Import useDroppable from @dnd-kit/core
    2. Import DropZoneData from @/types/dnd
    3. Call useDroppable with:
       - id: `slot-${dayIndex}-${slotIndex}` (unique per slot)
       - data: { zone: 'timegrid', dayIndex, slotIndex } satisfies DropZoneData
    4. Destructure: { setNodeRef, isOver }
    5. Apply ref={setNodeRef} to the div
    6. Add isOver styling: bg-primary/20 ring-1 ring-primary when isOver is true

    **TimeGrid.tsx:**
    1. Import useWeekStore, selectTimeBlocksByDay from stores
    2. Import TimeBlock component
    3. Get blocks for this day using useMemo (hydration safety)
    4. Render TimeBlock components for each block
    5. TimeGrid needs position: relative so TimeBlock absolute positioning works
    6. Blocks render as siblings to the TimeSlot elements, using absolute positioning

    TimeGrid structure:
    ```tsx
    <div className="relative">
      {/* Grid of slots */}
      {TIME_SLOTS.map(slot => <TimeSlot key={slot} ... />)}
      {/* Blocks overlaid with absolute positioning */}
      {blocks.map(block => <TimeBlock key={block.id} block={block} />)}
    </div>
    ```
  </action>
  <verify>npm run build passes; dragging over time slots shows visual feedback</verify>
  <done>TimeSlots are drop zones; TimeBlocks render with correct positioning</done>
</task>

<task type="auto">
  <name>Task 3: Make EveningSlot a drop zone and render block</name>
  <files>src/components/calendar/EveningSlot.tsx</files>
  <action>
    Convert EveningSlot to droppable and display evening blocks:

    1. Import useDroppable from @dnd-kit/core
    2. Import DropZoneData from @/types/dnd
    3. Import useWeekStore, selectEveningBlock from stores
    4. Import getRoleColorStyle from @/lib/role-colors
    5. Call useDroppable with:
       - id: `evening-${dayIndex}` (unique per day)
       - data: { zone: 'evening', dayIndex } satisfies DropZoneData
    6. Destructure: { setNodeRef, isOver }
    7. Apply ref={setNodeRef} to container
    8. Add isOver styling: bg-primary/10 ring-1 ring-primary/50
    9. Get evening block: const eveningBlock = useWeekStore(state => selectEveningBlock(state, dayIndex))
    10. If eveningBlock exists, render it with:
        - Role color background/border
        - Title text
        - Delete button on hover
    11. If no block, show the placeholder text

    Store also has deleteEveningBlock for the delete functionality.
  </action>
  <verify>npm run build passes; evening slot shows highlight on drag over</verify>
  <done>EveningSlot is a drop zone that displays evening blocks with delete capability</done>
</task>

<task type="auto">
  <name>Task 4: Handle timegrid and evening drops in DndProvider</name>
  <files>src/components/dnd/DndProvider.tsx</files>
  <action>
    Extend onDragEnd to handle timegrid and evening drops:

    1. Import TimeSlotIndex from @/types
    2. Get addTimeBlock and addEveningBlock from weekStore
    3. In handleDragEnd, add cases for:

    **timegrid zone (creates 1-hour block):**
    ```typescript
    if (dragData.type === 'goal' && dropData.zone === 'timegrid') {
      addTimeBlock({
        type: 'goal',
        goalId: dragData.goalId,
        roleId: dragData.roleId,
        dayIndex: dropData.dayIndex as DayOfWeek,
        startSlot: dropData.slotIndex as TimeSlotIndex,
        duration: 2, // 1 hour = 2 x 30-min slots
        title: dragData.text,
        completed: false,
      });
    }
    ```

    **evening zone:**
    ```typescript
    if (dragData.type === 'goal' && dropData.zone === 'evening') {
      // Check if evening slot is already occupied
      const existingBlock = weekStore.currentWeek?.eveningBlocks.find(
        b => b.dayIndex === dropData.dayIndex
      );
      if (existingBlock) {
        // Evening slot already has a block - could show toast/alert, for now just skip
        return;
      }
      addEveningBlock({
        type: 'goal',
        goalId: dragData.goalId,
        roleId: dragData.roleId,
        dayIndex: dropData.dayIndex as DayOfWeek,
        title: dragData.text,
        completed: false,
      });
    }
    ```

    Note: weekStore throws error if evening slot is occupied, so we check first.
  </action>
  <verify>npm run build passes; dropping on time slot creates block; dropping on evening creates evening block</verify>
  <done>Dropping goals on calendar creates TimeBlock or EveningBlock</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] Dragging over time slots shows visual highlight
- [ ] Dropping goal on time slot creates 1-hour block starting at that slot
- [ ] TimeBlock displays with correct height, position, and role color
- [ ] Dragging over evening slot shows visual highlight
- [ ] Dropping goal on evening creates evening block
- [ ] Evening block displays with role color and title
- [ ] Can delete time blocks and evening blocks
- [ ] Same goal can be dropped multiple times on different slots
</verification>

<success_criteria>

- TimeSlot components are drop zones with visual feedback
- Dropping goal creates 1-hour TimeBlock at drop position
- TimeBlock renders with correct height/position based on duration/startSlot
- EveningSlot is a drop zone with visual feedback
- Dropping goal creates EveningBlock
- Both block types display with role color and delete capability
</success_criteria>

<output>
After completion, create `.planning/phases/05-drag-drop-integration/05-03-SUMMARY.md`
</output>
