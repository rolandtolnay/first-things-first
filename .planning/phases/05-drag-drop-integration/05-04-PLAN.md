---
phase: 05-drag-drop-integration
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - src/components/calendar/TimeBlock.tsx
  - src/components/dnd/DndProvider.tsx
  - src/components/dnd/DragOverlayContent.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag an existing time block"
    - "Dropping block on different day moves it to that day"
    - "Block maintains its duration when moved"
    - "Block updates to new slot position when moved"
  artifacts:
    - path: "src/components/calendar/TimeBlock.tsx"
      provides: "Draggable time block"
      contains: "useDraggable"
  key_links:
    - from: "TimeBlock"
      to: "DndContext"
      via: "useDraggable hook"
      pattern: "useDraggable"
    - from: "DndProvider onDragEnd"
      to: "weekStore.updateTimeBlock"
      via: "drop handler for block type"
      pattern: "updateTimeBlock"
---

<objective>
Enable dragging existing time blocks to move them between days or time slots.

Purpose: Allow reorganization of scheduled blocks via drag-drop.
Output: Time blocks can be dragged and dropped to different slots/days.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-drag-drop-integration/05-RESEARCH.md
@.planning/phases/05-drag-drop-integration/05-02-SUMMARY.md
@.planning/phases/05-drag-drop-integration/05-03-SUMMARY.md

@src/components/calendar/TimeBlock.tsx
@src/components/dnd/DndProvider.tsx
@src/components/dnd/DragOverlayContent.tsx
@src/types/dnd.ts
@src/stores/weekStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make TimeBlock draggable</name>
  <files>src/components/calendar/TimeBlock.tsx</files>
  <action>
    Add drag capability to TimeBlock:

    1. Import useDraggable from @dnd-kit/core
    2. Import BlockDragData from @/types/dnd
    3. Call useDraggable with:
       - id: `block-${block.id}` (unique across all draggables)
       - data: { type: 'block', blockId: block.id, sourceDay: block.dayIndex } satisfies BlockDragData
    4. Destructure: { attributes, listeners, setNodeRef, isDragging }
    5. Apply to the block container:
       - ref={setNodeRef}
       - {...listeners}
       - {...attributes}
    6. Add isDragging styling: opacity-50 when dragging
    7. Add cursor-grab to the block (changes to cursor-grabbing during drag via CSS)

    **Note:** The delete button should still work - listener events don't prevent child button clicks.
  </action>
  <verify>npm run build passes; blocks show grab cursor and can be picked up</verify>
  <done>TimeBlock is draggable with visual feedback during drag</done>
</task>

<task type="auto">
  <name>Task 2: Update DragOverlayContent for block preview</name>
  <files>src/components/dnd/DragOverlayContent.tsx</files>
  <action>
    Enhance DragOverlayContent to handle block type:

    1. Import useWeekStore to look up block details
    2. For type 'block':
       - Find the block in currentWeek.timeBlocks by blockId
       - Render a preview similar to TimeBlock:
         - Role color background/border
         - Title text
         - Approximate height based on duration (though fixed size is fine for overlay)
       - Use same shadow-lg, pointer-events-none styling

    The overlay should look like a floating TimeBlock so the user knows what they're dragging.
  </action>
  <verify>npm run build passes; dragging block shows block preview</verify>
  <done>DragOverlay shows appropriate preview for both goals and blocks</done>
</task>

<task type="auto">
  <name>Task 3: Handle block drops in DndProvider</name>
  <files>src/components/dnd/DndProvider.tsx</files>
  <action>
    Extend onDragEnd to handle block-to-slot drops:

    1. Import BlockDragData from @/types/dnd
    2. Get updateTimeBlock from weekStore
    3. Add case for block type dropped on timegrid:

    ```typescript
    if (dragData.type === 'block' && dropData.zone === 'timegrid') {
      // Move block to new day/slot
      updateTimeBlock(dragData.blockId, {
        dayIndex: dropData.dayIndex as DayOfWeek,
        startSlot: dropData.slotIndex as TimeSlotIndex,
      });
    }
    ```

    The block keeps its original duration, type, goalId, roleId, title - only dayIndex and startSlot change.

    **Future consideration (not this plan):** Overlap prevention will be added in Phase 6. For now, blocks can overlap.
  </action>
  <verify>npm run build passes; dragging block to new slot moves it</verify>
  <done>Dropping block on time slot updates its day and position</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] TimeBlock shows grab cursor and can be dragged
- [ ] Dragging block shows preview in DragOverlay
- [ ] Block reduces opacity while dragging
- [ ] Dropping block on same day, different slot moves it
- [ ] Dropping block on different day moves it to that day
- [ ] Block maintains its duration after move
- [ ] Block maintains its title, goalId, roleId after move
</verification>

<success_criteria>

- TimeBlock has drag capability via useDraggable
- DragOverlay shows block preview during drag
- Dropping block on time slot updates its position
- Block movement works within same day and across days
- All block properties (duration, title, etc.) preserved during move
</success_criteria>

<output>
After completion, create `.planning/phases/05-drag-drop-integration/05-04-SUMMARY.md`
</output>
