---
phase: 01-foundation-data-layer
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/types/index.ts
  - src/lib/db.ts
  - src/stores/weekStore.ts
  - src/stores/uiStore.ts
  - src/lib/utils.ts
autonomous: true
must_haves:
  truths:
    - "Week data persists in IndexedDB across browser restarts"
    - "Week data structure includes roles array with color assignment"
    - "Each week is independent (snapshot model)"
    - "Safari storage persistence is requested on first use"
  artifacts:
    - path: "src/types/index.ts"
      provides: "TypeScript types for Role, Goal, TimeBlock, Week"
      min_lines: 30
      contains: "interface Week"
    - path: "src/lib/db.ts"
      provides: "Dexie database with weeks table"
      min_lines: 20
      contains: "Dexie"
    - path: "src/stores/weekStore.ts"
      provides: "Zustand store for week data with Dexie integration"
      min_lines: 40
      contains: "create"
  key_links:
    - from: "src/stores/weekStore.ts"
      to: "src/lib/db.ts"
      via: "import and database operations"
      pattern: "import.*db"
    - from: "src/stores/weekStore.ts"
      to: "src/types/index.ts"
      via: "type imports"
      pattern: "import.*types"
    - from: "src/lib/db.ts"
      to: "src/types/index.ts"
      via: "schema type alignment"
      pattern: "import.*types"
---

<objective>
Implement the data layer with Dexie.js for IndexedDB persistence and Zustand for state management.

Purpose: Establish reliable data persistence that survives browser restarts and implements the week snapshot model.
Output: TypeScript types, database schema, and stores that enable all future data operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@.planning/research/ARCHITECTURE.md

Key data model requirements from PROJECT.md:
- Week snapshot model: each week is independent
- Roles editable per-week independently
- Blocks track type (manual vs goal) and role reference
- 30-minute granularity for time blocks
- Fixed 8:00-20:00 time range + evening slot

Critical from research:
- Safari IndexedDB eviction after 7 days - must call navigator.storage.persist()
- Use Dexie.js 4.x with dexie-react-hooks
- Zustand for UI state, synced with Dexie for persistence
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define TypeScript types for data model</name>
  <files>src/types/index.ts</files>
  <action>
    Create comprehensive TypeScript types:

    ```typescript
    // Role with auto-assigned color
    interface Role {
      id: string;           // UUID
      name: string;
      color: string;        // From palette (e.g., "teal", "amber", "rose")
      order: number;        // Display order in sidebar
    }

    // Goal belongs to a role, can appear in multiple places
    interface Goal {
      id: string;           // UUID
      roleId: string;       // References Role.id
      text: string;
      notes?: string;       // Optional notes
      completed: boolean;   // Completion in role column
    }

    // DayPriority - goal instance in Day Priorities section
    interface DayPriority {
      id: string;
      goalId: string;       // References Goal.id
      dayIndex: number;     // 0-6 (Sunday-Saturday)
      order: number;        // Position in priorities list
      completed: boolean;   // Independent completion status
    }

    // TimeBlock - scheduled time on calendar
    interface TimeBlock {
      id: string;
      type: 'goal' | 'freestyle';
      goalId?: string;      // Only if type === 'goal'
      roleId?: string;      // For color coding (from goal's role or manual assignment)
      dayIndex: number;     // 0-6
      startSlot: number;    // 0-23 (8:00=0, 8:30=1, 9:00=2, etc. up to 19:30=23)
      duration: number;     // In 30-min slots (min 1, max 16 for 8 hours)
      title: string;        // Display text (goal text or freestyle title)
      completed: boolean;
    }

    // Evening slot - single block capacity per day
    interface EveningBlock {
      id: string;
      type: 'goal' | 'freestyle';
      goalId?: string;
      roleId?: string;
      dayIndex: number;
      title: string;
      completed: boolean;
    }

    // Week - the main container (snapshot model)
    interface Week {
      id: string;           // ISO week string e.g., "2026-W03"
      startDate: string;    // ISO date of Monday
      roles: Role[];
      goals: Goal[];
      dayPriorities: DayPriority[];
      timeBlocks: TimeBlock[];
      eveningBlocks: EveningBlock[];
      createdAt: string;    // ISO datetime
      updatedAt: string;    // ISO datetime
    }
    ```

    Also create helper types:
    - WeekId (branded string type)
    - RoleColor (union of allowed colors)
    - DayOfWeek (0-6 union)

    Export all types.
  </action>
  <verify>TypeScript compiles with no errors: npx tsc --noEmit</verify>
  <done>All data model types defined and exported</done>
</task>

<task type="auto">
  <name>Task 2: Create Dexie database with schema</name>
  <files>src/lib/db.ts, src/lib/utils.ts</files>
  <action>
    Create Dexie database instance:

    ```typescript
    import Dexie, { Table } from 'dexie';
    import type { Week } from '@/types';

    class FirstThingsFirstDB extends Dexie {
      weeks!: Table<Week, string>;

      constructor() {
        super('FirstThingsFirst');
        this.version(1).stores({
          weeks: 'id, startDate, createdAt'
        });
      }
    }

    export const db = new FirstThingsFirstDB();
    ```

    Add initialization function that:
    1. Requests persistent storage: navigator.storage.persist()
    2. Logs persistence status for debugging
    3. Handles Safari-specific storage concerns

    Create utility functions in utils.ts:
    - generateId(): string - UUID generation (crypto.randomUUID())
    - getWeekId(date: Date): string - Returns "2026-W03" format
    - getWeekStartDate(date: Date): Date - Returns Monday of that week
    - formatWeekId(weekId: string): string - Human readable "Jan 13-19, 2026"

    DO NOT use external UUID library - crypto.randomUUID() is supported in all modern browsers.
  </action>
  <verify>Import db in a test file and verify no TypeScript errors</verify>
  <done>Database schema defined, utilities created</done>
</task>

<task type="auto">
  <name>Task 3: Create Zustand stores with Dexie integration</name>
  <files>src/stores/weekStore.ts, src/stores/uiStore.ts</files>
  <action>
    Create weekStore.ts with Zustand:

    ```typescript
    import { create } from 'zustand';
    import { db } from '@/lib/db';
    import type { Week, Role, Goal, TimeBlock, DayPriority, EveningBlock } from '@/types';

    interface WeekStore {
      // Current week data
      currentWeek: Week | null;
      isLoading: boolean;
      error: string | null;

      // Actions
      loadWeek: (weekId: string) => Promise<void>;
      createWeek: (weekId: string, carryOverRoles?: Role[]) => Promise<Week>;

      // Role operations
      addRole: (name: string) => Promise<void>;
      updateRole: (roleId: string, updates: Partial<Role>) => Promise<void>;
      deleteRole: (roleId: string) => Promise<void>;

      // Goal operations
      addGoal: (roleId: string, text: string, notes?: string) => Promise<void>;
      updateGoal: (goalId: string, updates: Partial<Goal>) => Promise<void>;
      deleteGoal: (goalId: string) => Promise<void>;

      // Save current week to IndexedDB
      saveWeek: () => Promise<void>;
    }
    ```

    Implementation notes:
    - Use optimistic updates (update state immediately, then persist)
    - loadWeek checks if week exists, creates if not
    - Auto-assign role colors from a predefined palette
    - All mutations update updatedAt timestamp
    - saveWeek debounced or called after each mutation

    Create uiStore.ts for transient state (not persisted):

    ```typescript
    interface UIStore {
      // Drag state (for dnd-kit)
      isDragging: boolean;
      dragSource: { type: 'goal' | 'block'; id: string } | null;

      // Selection
      selectedBlockId: string | null;

      // Actions
      setDragging: (isDragging: boolean) => void;
      setDragSource: (source: UIStore['dragSource']) => void;
      setSelectedBlock: (id: string | null) => void;
    }
    ```

    This store is NOT persisted - it's for UI-only state.
  </action>
  <verify>Import stores and verify TypeScript compiles</verify>
  <done>Both stores created with proper typing and Dexie integration</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All TypeScript types compile without errors
- [ ] Dexie database can be initialized (test in browser console)
- [ ] navigator.storage.persist() is called on database init
- [ ] Zustand stores export correctly
- [ ] Week model supports independent snapshots (no shared references)
- [ ] Role color palette defined with 8+ distinct colors
</verification>

<success_criteria>

- All tasks completed
- Types define complete data model for weekly planner
- Dexie database initializes and handles Safari persistence
- Zustand stores provide clean API for data operations
- Week snapshot model is properly implemented
  </success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-layer/01-02-SUMMARY.md`
</output>
